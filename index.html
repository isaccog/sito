<html>
<head>
  <meta charset="UTF-8" />
  <title>Grafico a Bolle Interattivo - Evidenzia x=0 e y=0</title>

  <!-- Bootstrap 5 CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
  />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Layout di base */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    /* Contenitore per centrare */
    .chart-container {
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background-color: #f8f9fa; 
      padding: 1rem;
    }
    #myChart {
      cursor: crosshair;
      border: 1px solid #ddd;
      background-color: #fff;
    }
  </style>
</head>

<body>
<div id="header"></div> 
<div class="chart-container">
  <div class="card shadow" style="padding: 1rem;">
    <h3 class="text-center mb-3">Inserisci qui quello che fai</h3>
    <canvas id="myChart" width="600" height="400"></canvas>
  </div>
</div>

<!-- Modale Bootstrap -->
<div 
  class="modal fade" 
  id="myModal" 
  tabindex="-1" 
  aria-labelledby="myModalLabel" 
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="myModalLabel">Aggiungi/Modifica Attività</h5>
        <button 
          type="button" 
          class="btn-close" 
          data-bs-dismiss="modal" 
          aria-label="Close"
          id="closeXBtn"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="activityName" class="form-label">
            Nome attività <span class="text-danger">*</span>
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="activityName" 
            placeholder="Inserisci nome..." 
            required
          />
        </div>

        <div class="mb-3">
          <label for="timeSpent" class="form-label">
            Tempo impiegato (raggio) <small>(1-10)</small> <span class="text-danger">*</span>
          </label>
          <input 
            type="number" 
            class="form-control" 
            id="timeSpent" 
            placeholder="Inserisci un valore 1-10" 
            min="1" 
            max="10"
            required
          />
        </div>

        <div class="mb-3">
          <label for="colorPicker" class="form-label">
            Colore palla <span class="text-danger">*</span>
          </label>
          <input 
            type="color" 
            class="form-control form-control-color" 
            id="colorPicker" 
            value="#29b6f6"
            title="Scegli un colore"
            required
          />
        </div>
      </div>
      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary" 
          id="cancelBtn" 
          data-bs-dismiss="modal"
        >
          Annulla
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          id="saveBtn"
        >
          Salva
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS (necessario per la modale) -->
<script 
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>

<script>
  // Inizializza la modale di Bootstrap
  const myModal = new bootstrap.Modal(document.getElementById('myModal'), {
    backdrop: 'static'
  });

  // Riferimenti ai campi della modale
  const activityName   = document.getElementById('activityName');
  const timeSpentInput = document.getElementById('timeSpent');
  const colorPicker    = document.getElementById('colorPicker');
  const saveBtn        = document.getElementById('saveBtn');
  const cancelBtn      = document.getElementById('cancelBtn');
  const closeXBtn      = document.getElementById('closeXBtn');

  // Variabili per la logica di creazione/modifica
  let editIndex = null;
  let tempX = 0;
  let tempY = 0;

  // Configuriamo il grafico
  const ctx = document.getElementById('myChart').getContext('2d');

  const myChart = new Chart(ctx, {
    type: 'bubble',
    data: {
      datasets: [
        {
          label: 'Attività',
          data: []
        }
      ]
    },
    options: {
      responsive: false,
      scales: {
        x: {
          title: {
            display: true,
            text: 'Asse X: Quanto mi viene da fare una cosa'
          },
          min: -10,
          max: 10,
          // Mostriamo solo la linea di x=0 (in nero), le altre linee sono trasparenti
          grid: {
            color: (ctx) => (ctx.tick.value === 0 ? '#000' : 'transparent'),
            lineWidth: (ctx) => (ctx.tick.value === 0 ? 2 : 0)
          },
          border: {
            display: false
          }
        },
        y: {
          title: {
            display: true,
            text: 'Asse Y: Quanto mi piace una cosa'
          },
          min: -10,
          max: 10,
          // Mostriamo solo la linea di y=0 (in nero), le altre linee sono trasparenti
          grid: {
            color: (ctx) => (ctx.tick.value === 0 ? '#000' : 'transparent'),
            lineWidth: (ctx) => (ctx.tick.value === 0 ? 2 : 0)
          },
          border: {
            display: false
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const pointData = context.dataset.data[context.dataIndex];
              return (
                pointData.label +
                ' (X: ' + pointData.x +
                ', Y: ' + pointData.y +
                ', r: ' + pointData.r +
                (pointData.colore ? ', colore: ' + pointData.colore : '') + ')'
              );
            }
          }
        }
      }
    }
  });

  // Funzioni per mostrare/nascondere la modale
  function showModal(data = null) {
    if (data) {
      // Modal in modifica
      document.getElementById('myModalLabel').textContent = 'Modifica Attività';
      activityName.value       = data.label || '';
      timeSpentInput.value     = data.r || '';
      colorPicker.value        = data.colore || data.backgroundColor || '#29b6f6';
      tempX = data.x;
      tempY = data.y;
    } else {
      // Modal in creazione
      document.getElementById('myModalLabel').textContent = 'Aggiungi Attività';
      activityName.value       = '';
      timeSpentInput.value     = '';
      colorPicker.value        = '#29b6f6';
    }
    myModal.show();
  }
  function hideModal() {
    myModal.hide();
  }

  // Gestione click sul grafico
  myChart.canvas.addEventListener('click', function(e) {
    // Controlliamo se è un click su una bolla esistente
    const points = myChart.getElementsAtEventForMode(
      e, 
      'nearest', 
      { intersect: true }, 
      true
    );

    if (points.length > 0) {
      // MODIFICA
      const firstPoint   = points[0];
      const datasetIndex = firstPoint.datasetIndex;
      const index        = firstPoint.index;

      const pointData = myChart.data.datasets[datasetIndex].data[index];
      editIndex = index;
      showModal(pointData);
    } else {
      // CREAZIONE NUOVO PUNTO
      const xVal = myChart.scales.x.getValueForPixel(e.offsetX);
      const yVal = myChart.scales.y.getValueForPixel(e.offsetY);

      tempX = parseFloat(xVal.toFixed(1));
      tempY = parseFloat(yVal.toFixed(1));
      editIndex = null;
      showModal();
    }
  });

  // Click su "Salva"
  saveBtn.addEventListener('click', () => {
    const nameAttivita = activityName.value.trim();
    const color        = colorPicker.value;
    let r              = parseFloat(timeSpentInput.value);

    // Validazioni
    if (!nameAttivita) {
      alert("Il nome dell'attività è obbligatorio.");
      return;
    }
    if (isNaN(r) || r < 1 || r > 10) {
      alert("Il raggio deve essere un numero fra 1 e 10.");
      return;
    }
    if (!color) {
      alert("Il colore è obbligatorio.");
      return;
    }

    if (editIndex !== null) {
      // MODIFICA
      myChart.data.datasets[0].data[editIndex] = {
        x: tempX,
        y: tempY,
        r: r,
        label: nameAttivita,
        backgroundColor: color,
        colore: color
      };
    } else {
      // CREAZIONE
      myChart.data.datasets[0].data.push({
        x: tempX,
        y: tempY,
        r: r,
        label: nameAttivita,
        backgroundColor: color,
        colore: color
      });
    }

    myChart.update();
    hideModal();
  });

  // Pulsanti di annullamento/chiusura
  cancelBtn.addEventListener('click', hideModal);
  closeXBtn.addEventListener('click', hideModal);
</script>
<div id="footer"></div> 
  <script>
  fetch('header.html')
    .then(resp => resp.text())
    .then(data => {
      document.getElementById('header').innerHTML = data;
    });

  fetch('footer.html')
    .then(resp => resp.text())
    .then(data => {
      document.getElementById('footer').innerHTML = data;
    });
</script>
  <div id="footer"></div>
</body>
</html>
