<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Grafico a Bolle Interattivo</title>
  <!-- Chart.js da CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Centriamo la pagina e il grafico */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f0f0f0;
      box-sizing: border-box;
    }

    #chartContainer {
      background-color: #ffffff;
      padding: 20px;
      border: 1px solid #ccc;
      position: relative;
    }

    #myChart {
      cursor: crosshair; /* Indica che si può cliccare */
    }

    /* Stili per la modale */
    #modalOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      display: none; /* Inizialmente nascosto */
      justify-content: center;
      align-items: center;
    }
    #modalContent {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      min-width: 300px;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    input[type="text"],
    input[type="number"],
    input[type="color"] {
      width: 90%;
      margin-bottom: 0.5rem;
    }
    button {
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
  </style>
</head>

<body>

<div id="chartContainer">
  <canvas id="myChart" width="600" height="400"></canvas>
</div>

<!-- Modale per la creazione/modifica dei dati del punto -->
<div id="modalOverlay">
  <div id="modalContent">
    <h2 id="modalTitle">Aggiungi/Modifica Attività</h2>

    <label for="activityName">Nome attività:</label>
    <input type="text" id="activityName" placeholder="Inserisci nome..." />

    <label for="timeSpent">Tempo impiegato (raggio):</label>
    <input type="number" id="timeSpent" placeholder="Inserisci un valore 1-10" min="1" max="10" />

    <label for="colorPicker">Colore palla:</label>
    <input type="color" id="colorPicker" value="#29b6f6" />

    <button id="saveBtn">Salva</button>
    <button id="cancelBtn">Annulla</button>
  </div>
</div>

<script>
  // Inizializziamo il grafico a bolle vuoto
  const ctx = document.getElementById('myChart').getContext('2d');
  
  const myChart = new Chart(ctx, {
    type: 'bubble',
    data: {
      datasets: [{
        label: 'Attività',
        data: []
      }]
    },
    options: {
      responsive: false,
      scales: {
        x: {
          title: {
            display: true,
            text: 'Asse X: Quanto mi viene da fare una cosa'
          },
          min: -10,
          max: 10,
          // Rimuoviamo la griglia, ma lasciamo l’asse visibile in nero e “bold”
          grid: {
            display: false
          },
          xAxes: {
            display: true,
            color: '#000',    // Colore nero
            width: 3          // Spessore dell’asse (simile a "grassetto")
          }
        },
        y: {
          title: {
            display: true,
            text: 'Asse Y: Quanto mi piace una cosa'
          },
          min: -10,
          max: 10,
          grid: {
            display: false
          },
          border: {
            display: true,
            color: '#000',    // Colore nero
            width: 3          // Spessore dell’asse
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const pointData = context.dataset.data[context.dataIndex];
              return (
                pointData.label + 
                ' (X: ' + pointData.x + 
                ', Y: ' + pointData.y +
                ', r: ' + pointData.r + 
                ', colore: ' + pointData.colore + ')'
              );
            }
          }
        }
      }
    }
  });

  // Variabili di riferimento per la modale e i campi
  const modalOverlay   = document.getElementById('modalOverlay');
  const modalTitle     = document.getElementById('modalTitle');
  const activityName   = document.getElementById('activityName');
  const timeSpentInput = document.getElementById('timeSpent');
  const colorPicker    = document.getElementById('colorPicker');
  const saveBtn        = document.getElementById('saveBtn');
  const cancelBtn      = document.getElementById('cancelBtn');

  // Variabili per distinguere se stiamo creando o modificando
  // e per conservare temporaneamente le coordinate
  let editIndex = null; // Se è null -> creazione; se ha valore -> modifica
  let tempX = 0;
  let tempY = 0;

  // Funzione per mostrare la modale
  // Se passiamo un oggetto "existingData", popola i campi per modificare un punto esistente
  // Altrimenti, inizializziamo i campi per un nuovo punto
  function showModal(existingData = null) {
    modalOverlay.style.display = 'flex';

    if (existingData) {
      // Stiamo modificando un punto
      modalTitle.textContent   = 'Modifica Attività';
      activityName.value       = existingData.label || '';
      timeSpentInput.value     = existingData.r || '';
      colorPicker.value        = existingData.colore || existingData.backgroundColor || '#29b6f6';
      // Manteniamo le coordinate esistenti
      tempX = existingData.x;
      tempY = existingData.y;
    } else {
      // Creazione nuovo punto
      modalTitle.textContent   = 'Aggiungi Attività';
      activityName.value       = '';
      timeSpentInput.value     = '';
      colorPicker.value        = '#29b6f6';
      // tempX e tempY sono già impostati dal click su uno spazio vuoto
    }
  }

  // Funzione per nascondere la modale
  function hideModal() {
    modalOverlay.style.display = 'none';
  }

  // Intercettiamo il click sul canvas
  myChart.canvas.addEventListener('click', function(e) {
    // Verifichiamo se l'utente ha cliccato su una bolla esistente
    const points = myChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);

    if (points.length > 0) {
      // Abbiamo cliccato su un punto esistente -> MODIFICA
      const firstPoint   = points[0];
      const datasetIndex = firstPoint.datasetIndex;
      const index        = firstPoint.index;

      const pointData = myChart.data.datasets[datasetIndex].data[index];
      editIndex = index; // Salviamo quale punto stiamo modificando

      showModal(pointData); // Passiamo i dati esistenti al form
    } else {
      // Nessun punto cliccato -> CREAZIONE di un nuovo punto
      // Ricaviamo le coordinate cliccate
      const xVal = myChart.scales.x.getValueForPixel(e.offsetX);
      const yVal = myChart.scales.y.getValueForPixel(e.offsetY);

      tempX = parseFloat(xVal.toFixed(1));
      tempY = parseFloat(yVal.toFixed(1));

      editIndex = null; // Indica che stiamo creando un nuovo punto
      showModal();
    }
  });

  // Al click su "Salva", creiamo o modifichiamo il punto
  saveBtn.addEventListener('click', () => {
    const nameAttivita = activityName.value.trim();
    const color        = colorPicker.value;
    let r              = parseFloat(timeSpentInput.value);

    // Verifica che tutti i campi siano validi e obbligatori
    if (!nameAttivita) {
      alert("Il nome dell'attività è obbligatorio.");
      return;
    }

    if (isNaN(r) || r <= 0 || r > 10) {
      alert("Il raggio deve essere un numero fra 0 e 10 (escluso 0, incluso 10).");
      return;
    }

    if (!color) {
      alert("Il colore è obbligatorio.");
      return;
    }

    if (editIndex !== null) {
      // Stiamo MODIFICANDO un punto esistente
      myChart.data.datasets[0].data[editIndex] = {
        x: tempX,
        y: tempY,
        r: r,
        label: nameAttivita,
        backgroundColor: color,
        colore: color // nuova proprietà aggiuntiva
      };
    } else {
      // Stiamo CREANDO un nuovo punto
      myChart.data.datasets[0].data.push({
        x: tempX,
        y: tempY,
        r: r,
        label: nameAttivita,
        backgroundColor: color,
        colore: color // nuova proprietà aggiuntiva
      });
    }

    myChart.update();
    hideModal();
  });

  // Al click su "Annulla", chiudiamo la modale senza salvare
  cancelBtn.addEventListener('click', () => {
    hideModal();
  });
</script>

</body>
</html>
